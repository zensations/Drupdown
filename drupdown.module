<?php
/**
 * Implements hook_menu().
 */
function drupdown_menu() {
  return array(
    'admin/config/content/drupdown' => array(
      'title' => t('Drupdown Playground'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('drupdown_playground'),
      'access arguments' => array('access administration pages'),
      'file' => 'includes/drupdown.pages.inc',
    ),
  );
}

/**
 * Implements hook_requirejs_paths().
 */
function drupdown_requirejs_paths() {
  return array(
    'drupdown' => drupal_get_path('module', 'drupdown') . '/js',
  );
}

/**
 * Implements hook_init().
 */
function drupdown_init() {
  drupal_add_css(drupal_get_path('module', 'drupdown') . '/css/drupdown.css');
  $rules = array();
}

/**
 * Implements hook_theme();
 */
function drupdown_theme() {
  return array(
    'figure' => array(
      'variables' => array(
        'content' => FALSE,
        'caption' => FALSE,
        'float' => 'center',
        'classes' => array(),
      ),
    ),
  );
}

/**
 * Implements hook_ace_plugins_alter().
 */
function drupdown_ace_plugins_alter(&$plugins) {
  $plugins['modes']['drupdown/mode'] = array(
    'title' => 'Drupdown',
  );
  $plugins['themes']['ace/theme/textmate'] = array(
    'attached' => array(
      'css' => array(
        drupal_get_path('module', 'drupdown') . '/themes/textmate.css',
      ),
    ),
  );
  $plugins['toolbars']['drupdown/toolbar'] = array(
    'title' => 'Drupdown',
    'attached' => array(
      'css' => array(
        drupal_get_path('module', 'drupdown') . '/css/toolbar.css',
      ),
      'library' => array(
        array('system', 'ui.dialog'),
        array('system', 'ui.autocomplete'),
        array('system', 'effects.fade'),
      ),
    ),
  );
}


/**
 * Implements hook_filter_info().
 */
function drupdown_filter_info() {
  $filters = array();
  $filters['filter_drupdown'] = array(
    'title' => t('Drupdown'),
    'description' => t('Extended Markdown with Drupal flavor.'),
    'process callback' => '_drupdown_process',
    'settings callback' => '_drupdown_settings',
    'default settings' => array('styles' => array()),
  );
  return $filters;
}

/**
 * Settings form callback.
 */
function _drupdown_settings($form, &$form_state, $filter, $format, $defaults, $filters) {
  $settings = array();
  $settings['styles'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Available image styles'),
    '#options' => array(
      'original' => 'original',
    ),
    '#default_value' => $filter->settings['styles'],
  );
  foreach (array_keys(image_styles()) as $style) {
    $settings['styles']['#options'][$style] = $style;
  }
  return $settings;
}

/**
 * Main process callback.
 */
function _drupdown_process($text, $filter, $format, $langcode, $cache, $cache_id) {
  module_load_include('inc', 'drupdown', 'includes/drupdown.parser');
  drupdown_process_blocks($text, $filter->settings);
}
