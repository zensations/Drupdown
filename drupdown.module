<?php
/**
 * Implements hook_menu().
 */
function drupdown_menu() {
  return array(
    'admin/config/content/drupdown' => array(
      'title' => t('Drupdown Playground'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('drupdown_playground'),
      'access arguments' => array('access administration pages'),
      'file' => 'includes/drupdown.pages.inc',
    ),
  );
}

/**
 * Implements hook_requirejs_paths().
 */
function drupdown_requirejs_paths() {
  return array(
    'drupdown' => drupal_get_path('module', 'drupdown') . '/js',
  );
}

/**
 * Retrieve all defined block elements.
 */
function drupdown_block_elements() {
  if (FALSE && $cache = cache_get('drupdown_block_elements')) {
    return $cache->data;
  }
  $elements = module_invoke_all('drupdown_block_elements');
  $elements['paragraph'] = array(
    'label' => t('Paragraph'),
    'pattern' => '/^(.+)$/',
    'process' => '_drupdown_paragraph',
    'weight' => 100,
  );
  $elements['heading'] = array(
    'label' => t('Heading'),
    'pattern' => '/^(#{1,6})(\s)(.*)$/',
    'process' => '_drupdown_heading',
    'token' => array('drupdown_operator', 'text', 'drupdown_heading'),
    'weight' => 50,
  );
  uasort($elements, 'drupal_sort_weight');
  cache_set('drupdown_block_elements', $elements);
  return $elements;
}

/**
 * Retrieve all defined span elements.
 */
function drupdown_span_elements() {
  if (FALSE && $cache = cache_get('drupdown_span_elements')) {
    return $cache->data;
  }
  $elements = module_invoke_all('drupdown_span_elements');
  $elements['emphasized'] = array(
    'label' => t('Emphasized'),
    'pattern' => '/(\_)(.*?)(\_)/',
    'process' => '_drupdown_emphasized',
    'token' => array('drupdown_operator', 'drupdown_emphasized', 'drupdown_operator'),
    'weight' => 50,
  );
  $elements['strong'] = array(
    'label' => t('Emphasized'),
    'pattern' => '/(\*)(.*?)(\*)/',
    'process' => '_drupdown_strong',
    'token' => array('drupdown_operator', 'drupdown_strong', 'drupdown_operator'),
    'weight' => 50,
  );
  uasort($elements, 'drupal_sort_weight');
  cache_set('drupdown_span_elements', $elements);
  return $elements;
}

/**
 * Implements hook_init().
 */
function drupdown_init() {
  drupal_add_css(drupal_get_path('module', 'drupdown') . '/css/drupdown.css');
  $rules = array();
  $block = drupdown_block_elements();
  $span = drupdown_span_elements();
  foreach (array($block, $span) as $elements) {
    foreach ($elements as $element) {
      if (array_key_exists('token', $element)) {
        $rules[] = array(
          'token' => $element['token'],
          'regex' => substr($element['pattern'], 1, -1),
        );
      }
    }
  }
  drupal_add_js(array('drupdown' => array('rules' => $rules)), 'setting');
}

/**
 * Implements hook_theme();
 */
function drupdown_theme() {
  return array(
    'figure' => array(
      'variables' => array(
        'content' => FALSE,
        'caption' => FALSE,
        'float' => 'center',
        'classes' => array(),
      ),
    ),
  );
}

/**
 * Implements hook_ace_plugins_alter().
 */
function drupdown_ace_plugins_alter(&$plugins) {
  $plugins['modes']['drupdown/mode'] = array(
    'title' => 'Drupdown',
  );
  $plugins['themes']['drupdown/theme'] = array(
    'title' => 'Drupdown',
    'class' => 'ace-drupdown',
    'attached' => array(
      'css' => array(
        drupal_get_path('module', 'drupdown') . '/css/syntax.css',
      ),
    ),
  );
  $plugins['toolbars']['drupdown/toolbar'] = array(
    'title' => 'Drupdown',
    'attached' => array(
      'css' => array(
        drupal_get_path('module', 'drupdown') . '/css/toolbar.css',
      ),
      'library' => array(
        array('system', 'ui.dialog'),
        array('system', 'ui.autocomplete'),
        array('system', 'effects.fade'),
      ),
    ),
  );
}


/**
 * Implements hook_filter_info().
 */
function drupdown_filter_info() {
  $filters = array();
  $filters['filter_drupdown'] = array(
    'title' => t('Drupdown'),
    'description' => t('Extended Markdown with Drupal flavor.'),
    'process callback' => '_drupdown_process',
    'settings callback' => '_drupdown_settings',
    'default settings' => array('styles' => array()),
  );
  return $filters;
}

/**
 * Settings form callback.
 */
function _drupdown_settings($form, &$form_state, $filter, $format, $defaults, $filters) {
  $settings = array();
  $settings['styles'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Available image styles'),
    '#options' => array(
      'original' => 'original',
    ),
    '#default_value' => $filter->settings['styles'],
  );
  foreach (array_keys(image_styles()) as $style) {
    $settings['styles']['#options'][$style] = $style;
  }
  return $settings;
}

/**
 * Main process callback.
 */
function _drupdown_process($text, $filter, $format, $langcode, $cache, $cache_id) {
  module_load_include('inc', 'drupdown', 'includes/drupdown.parser');
  drupdown_process_blocks($text, $filter->settings);
}
